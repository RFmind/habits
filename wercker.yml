box:
  id: python:3
  ports:
    - "5000"

services:
  - id: postgres
    env:
      POSTGRES_PASSWORD: apossword
      POSTGRES_USER: nameapassword

build:
  steps:
    
    - script:
        name: "Wait for Postgres"
        code: |
          while ! $(python -c "import socket; soc=socket.socket(); soc.connect(('$POSTGRES_PORT_5432_TCP_ADDR', $POSTGRES_PORT_5432_TCP_PORT))"); do sleep 3; done

    - pip-install

    - script:
        name: "Set environment vars"
        code: |
          export POSTGRES_USER=$POSTGRES_ENV_POSTGRES_USER
          export POSTGRES_PASSWORD=$POSTGRES_ENV_POSTGRES_PASSWORD
          export POSTGRES_HOST=$POSTGRES_PORT_5432_TCP_ADDR
          export POSTGRES_PORT=$POSTGRES_PORT_5432_TCP_PORT
          export POSTGRES_DB=habits_test
          export SETTINGS_MODE=TEST
    
    - script:
        name: "Run tests"
        code: python habits/server/tests.py

deploy:
  steps:
    - heroku-deploy:
        key: $HEROKU_KEY
        user: $HEROKU_USER
        app-name: $HEROKU_APP_NAME

