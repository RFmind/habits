box:
  id: python:3-alpine3.6
  ports:
    - "5000"

services:
  - id: postgres
    env:
      POSTGRES_PASSWORD: apassword
      POSTGRES_USER: nameapassword

build-server:
  steps:
    
    - script:
        name: "Wait for Postgres"
        code: |
          while ! $(python -c "import socket; soc=socket.socket(); soc.connect(('$POSTGRES_PORT_5432_TCP_ADDR', $POSTGRES_PORT_5432_TCP_PORT))"); do sleep 3; done

    - script:
        name: "Install missing dependencies"
        code: apk --update add postgresql-dev gcc python-dev py-pip musl-dev

    - pip-install

    - script:
        name: "Set environment vars"
        code: |
          export POSTGRES_USER=$POSTGRES_ENV_POSTGRES_USER
          export POSTGRES_PASSWORD=$POSTGRES_ENV_POSTGRES_PASSWORD
          export POSTGRES_HOST=$POSTGRES_PORT_5432_TCP_ADDR
          export POSTGRES_PORT=$POSTGRES_PORT_5432_TCP_PORT
          export POSTGRES_DB=habits_test
          export SETTINGS_MODE=TEST

    - script:
        name: "Run tests"
        code: python habits/server/tests.py

build-frontend:
  steps:
    - script:
        name: "Install NPM"
        code: apk --update add npm

    - script:
        name: "Install frontend dependencies"
        cwd: habits/static
        code: npm install

    - script:
        name: "Build application"
        cwd: habits/static
        code: npm run build

    - script:
        name: "Run tests"
        cwd: habits/static
        code: npm run tests

deploy:
  steps:
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        tag: latest
        repository: rfmind/habits
        registry: https://registry.hub.docker.com/v2
